<?php
/** @file
 *
 *  This is used to begin the streaming output of import results.
 *  The incoming view parameters should be:
 *      state       The current processing state
 *
 *  In-stream output is generated by:
 *      post-bookmarks-import-stream-begin.phtml        // Begin the stream
 *      post-bookmarks-import-stream-bookmark.phtml     // valid bookmark
 *      post-bookmarks-import-stream-error.phtml        // import error
 *      post-bookmarks-import-stream-warning.phtml      // import warning
 *
 *  The stream is ended with:
 *      post-bookmarks-import.phtml                     // Final results
 */

$tagStr     = implode(', ', $this->state['tagStack']);
$tagLabel   = 'tag' .(count($this->state['tagStack']) > 1 ? 's' : '');

$test       = ($this->state['test'] === 'yes'
                ? 'Testing '
                : '');
$visibility = $this->state['visibility'];
$conflict   = ($this->state['conflict'] === 'replace'
                ? 'replacing'
                : 'keeping');

$links = $this->headLink();
$links->appendStylesheet($this->baseUrl('/css/settings.css'))
      ->appendStylesheet($this->baseUrl('/css/bookmarks.css'));

$this->headTitle("Import");

/* Include the base-header information directly.
 *
 * Since layouts have been disabled, we must explicitly include these.
 */
echo $this->render('base-header.phtml');

?>
<div id='bookmark-import-results'>
 <h3><?= $test ?>Import of bookmarks using default <?= $tagLabel ?>
        <span class='tags'><?= $tagStr ?></span>,
    default visibility of
        <span class='privacy <?= $visibility ?>'><?= $visibility ?></span>,
    <?= $conflict ?> existing bookmarks.</h3>
 <div class='import-status'>
  <table>
   <thead>
    <tr>
     <th>lines</th><td id='line-count'>0</td>
     <th colspan='2'><a href='#imported'>imported</a></th>
     <th rowspan='2'><a href='#ignored'>ignored</a></th>
     <th rowspan='2'><a href='#error'>errors</a></th>
     <th rowspan='2'><a href='#warning'>warnings</a></th>
    </tr>
    <tr>
     <th>folders</th><td id='folder-count'>0</td>
     <th><a href='#new'>new</a></th>
     <th><a href='#updated'>updated</a></th>
    </tr>
   </thead>
   <tbody>
    <tr>
     <th><a href='#all'>bookmarks</a></th>
     <td id='bookmarks-count'>0</td>
     <td id='bookmarks-new'>0</td>
     <td id='bookmarks-updated'>0</td>
     <td id='bookmarks-ignored'>0</td>
     <td id='bookmarks-error'>0</td>
     <td id='bookmarks-warning'>0</td>
    </tr>
    <tr>
     <td colspan='7'>
      <div id='progressbar'></div>
     </td>
    </tr>
   </tbody>
  </table>
 </div>
 <script type='text/javascript'>
(function($) {
    var $status = $('.import-status');
    var $label  = null;
    var $items  = null;
    var $stats  = {
        progress:           $status.find('#progressbar').progressbar(),
        lineCount:          $status.find('#line-count'),
        folderCount:        $status.find('#folder-count'),
        bookmarksCount:     $status.find('#bookmarks-count'),
        bookmarksNew:       $status.find('#bookmarks-new'),
        bookmarksUpdated:   $status.find('#bookmarks-updated'),
        bookmarksIgnored:   $status.find('#bookmarks-ignored'),
        bookmarksError:     $status.find('#bookmarks-error'),
        bookmarksWarning:   $status.find('#bookmarks-warning')
    };

    var timeout = null;
    $status.delegate('a', 'click', function(e) {
        e.preventDefault();
        e.stopPropagation();

        if (timeout !== null)
        {
            clearTimeout(timeout);
            timeout = null;
        }

        if ($items === null)
        {
            $label = $('#filter-label');

            // Remove all 'script' tags from the item list
            $('ul.items').children('script').remove();

            $items = $('ul.items').children();  //find('> li');
        }

        var $a      = $(this);
        var type    = $a.attr('href').replace('#', '');

        // Hide all element EXCEPT those with a CSS class of 'type'
        var label   = 'Bookmarks';
        switch (type)
        {
        case 'all':         label = null;                   break;
        case 'new':         label = 'New Bookmarks';        break;
        case 'updated':     label = 'Updated Bookmarks';    break;
        case 'imported':    label = 'Imported Bookmarks';   break;
        case 'ignored':     label = 'Ignored Bookmarks';    break;
        case 'error':       label = 'Import Errors';        break;
        case 'warning':     label = 'Import Warnings';      break;
        default:
            // Unknown 'type'
            return;
        }

        var $show   = null;
        if (label !== null)
        {
            $show   = $items.filter('.'+ type);
            label += ' ('+ $show.length +' items)';
        }

        // Separate the visibility filtering from the UI thread.
        timeout = setTimeout(function() {
            if ($show === null)
            {
                // Show ALL
                $label.css('visibility', 'hidden');
                $items.show();
            }
            else
            {
                // Show JUST a specific type
                $label.text( label )
                      .css('visibility', 'visible');
                setTimeout(function() { $show.show(); }, 1);
                setTimeout(function() { $items.not('.'+ type).hide(); }, 10);
            }
            timeout = null;
        }, 10);
    });

    $.bookmarksImport_update = function( state ) {
        /* If this is a valid bookmark, state.html will be the server-renderd
         * version of the bookmark.
         */
        var complete    = (state.filePos / state.fileSize) * 100;
        $stats.progress.progressbar('value', complete);

        $stats.lineCount.text(state.lineNum);
        $stats.folderCount.text(state.numFolders);
        $stats.bookmarksCount.text(state.numBookmarks);
        $stats.bookmarksNew.text(state.numNew);
        $stats.bookmarksUpdated.text(state.numUpdated);
        $stats.bookmarksIgnored.text(state.numIgnored);
        $stats.bookmarksError.text(state.numErrors);
        $stats.bookmarksWarning.text(state.numWarnings);
    };
}(jQuery));
 </script>
 <h3 id='filter-label' style='visibility:hidden;'>Imported Bookmarks</h3>
 <ul class='items bookmarks'>
