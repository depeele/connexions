<?php
/** @file
 *
 *  View script for IndexController::index with incoming members:
 *      viewer          The Model_User instance representing the current
 *                      viewer;
 *      owner           The owner of the current item set -- either a string
 *                      or a Model_User instance;
 *      tagInfo         A Connexions_Set_Info instance containing
 *                      information about the requested tags;
 *      userItems       The Model_UserItemSet representing the items to
 *                      present;
 *      paginator       The paginator to use in presenting 'userItems';
 *
 *      itemsStyle      Presentation style for user items
 *                      (Connexions_View_Helpers_HtmlUserItems::STYLE_*);
 *      itemsSortBy     Sort User Items by
 *                      (a field from Model_UserItem::$model);
 *      itemsSortOrder  User Items sort order
 *                      (Connexions_View_Helpers_HtmlUserItems::
 *                                                          SORT_ORDER_*);
 *      itemsStyleCustom    An array of custom style settings
 *
 *      tagsMax         Maximum number of tags to present;
 *      tagsSortBy      Sort tags by (valid field of Model_Tag);
 *      tagsSortOrder   Tag sort order.
 */
$baseUrl = $this->baseUrl('/'); //Connexions::url('/');

$links = $this->headLink();
$links->appendStylesheet($baseUrl .'css/userItems.css');

if ($this->owner !== '*')
    $this->headTitle($this->owner ."'s Bookmarks");
else
    $this->headTitle('Bookmarks');

?>
<div class='columnHeader'>
 <p>Present the Bookmarks for <?= $this->owner ?>
                          to  <?= $this->viewer ?>
  <?php
    if ( $this->tagInfo->hasValidItems())
        printf (" with tags '%s'", $this->tagInfo->validItems);
    else
        printf (", NO tags.");
  ?>
 </p>
</div>

<div id='userItems'>
<?php
if ( @isset($this->userItems) )
{
    /* If $this->tagList is NOT set and we have 1 or more userItems, make use
     * of the 'userItems' Model_UserItemSet instance to retrieve the tags for
     * these userItems (specifically, for the unique items and unique users
     * represented by these userItems).
     */
    if ((! @isset($this->tagList)) && (count($this->userItems) > 0))
    {
        $userIds = $this->userItems->userIds();

        // Create a tag set and then retrieve its Tag_ItemList adapter
        $this->tagSet = new Model_TagSet( $userIds,
                                          $this->userItems->itemIds() );
        if ($this->owner === '*')
            $this->tagSet->withAnyUser();

        /*
        Connexions::log(
                sprintf("View Index: %s users, tag sql[ %s ]",
                            ($this->owner === '*' ? '*' : count($userIds)),
                            $this->tagSet->select()->assemble()));
        // */

        $this->tagList =
            $this->tagSet->get_Tag_ItemList(0, $this->tagsMax,
                                            $this->tagInfo,
                                            ($this->owner !== '*'
                                                ? null
                                                : '/tagged'));

        /* Add g_ScopeAutoSuggest data to our Javascript comprised of all
         * items in the current tag set.
         * :TODO:
         */
    }
}

if ( @isset($this->tagList))
{
    $time_start = microtime(true);

    $html = "<div class='columnHeader'>"
          .  "<p>Tag's shared by all the currently presented items.</p>"
          . "</div>";

    /* Use the Connexions_View_Helper_HtmlTagCloud class to render the tag
     * cloud for $this->tagList.
     */
    $html .= $this->htmlTagCloud($this->tagList,
                                 $this->tagsSortBy,
                                 $this->tagsSortOrder);

    $time_end   = microtime(true);
    $html .= sprintf ("%f seconds to render tag cloud<br />\n",
                      $time_end - $time_start);

    $this->layout()->right = $html;
}

/* Present the pagination control, established by
 * Bootstrap.php::_initViewGlobal() to be rendered via:
 *      views/scripts/paginationControl.phtml
 */
if (@isset($this->paginator))
{
    $uiHelper = $this->htmlUserItems();

    if (@is_array($this->itemsStyleCustom))
    {
        echo "\n<!-- itemsStyleCustom: ";
        print_r($this->itemsStyleCustom);
        echo " -->\n";

        $uiHelper->setStyle(Connexions_View_Helper_HtmlUserItems::STYLE_CUSTOM)
                 ->setShowMeta($this->itemsStyleCustom);
    }
    else
    {
        $uiHelper->setStyle($this->itemsStyle);
    }

    if (@isset($this->tagSet))
    {
        $uiHelper->setScopeItems($this->tagSet);
    }

    /* There a two ways we can do this:
     *   1. Individually invoke the set methods followed by the render();
     *   2. Directly invoke the render, passing in all values;
     *   3. Directly invoke the nameed method (htmlUserItems), passing in
     *      all values.
     */
    if (! @empty($this->itemsSortBy))
        $uiHelper->setSortBy($this->itemsSortBy);
    if (! @empty($this->itemsSortOrder))
        $uiHelper->setSortOrder($this->itemsSortOrder);

    echo $uiHelper->render($this->paginator,
                           $this->owner,
                           $this->viewer,
                           $this->tagInfo);
}

?>
</div>


<div class='error'><?= (@isset($this->error) ? $this->error : '') ?></div>
